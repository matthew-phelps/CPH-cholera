---
title: "Figures and Tables"
output: pdf_document
classoption: portrait
fontsize: 12pt
geometry: margin=1.5cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(dev = 'pdf')
pdf.options(encoding='ISOLatin2')
knitr::opts_knit$set(root.dir = normalizePath('..'))
knitr::opts_chunk$set(root.dir = normalizePath('..'))


```



```{r load, include=FALSE}
# INTRO -------------------------------------------------------------------
rm(list = ls())
library(pander)
library(tidyverse)
library(cowplot)
library(RColorBrewer)
source("functions/waic_dic_summary.R")
source("functions/MapBaseAndLayers.R")




```

```{r maps_load, include=FALSE}
source("Spatial-data-1.R")

```

```{r maps print, warning=FALSE, fig.width=7, fig.height=6.5}
options(warn = -1)

multiPlotWrapper(mapdf, wall_fort, water_fort, l_size = 0.1,
                 wall_l_size = 0.3, p_size = 1, txt_size = 10,
                 leg_height = 2.5)


```

## Figure 1
\newpage


```{r ts, warning=FALSE, fig.width=6.5, fig.height=6.5}
source("Data-3-combine quarters.R")
source("functions/plot-functions.R")
# City-wide time-series ---------------------------------------------------
outbreak_city <- quarter %>%
  group_by(week.id) %>%
  dplyr::summarise( sick = sum(sick.total.week),
                    dead = sum(dead.total.week)) %>%
  arrange(week.id) %>%
  mutate(week_date = week_date)

citywide <- citywide_plot(outbreak_city, txt_size = 11)

quarter <- quarter_panel_incidence(combined = combined, txt_size = 11)



ts_multi <- plot_grid(citywide, quarter,labels = c("A", "B"), ncol = 1, nrow = 2)
ts_multi
```

## Figure 2
Time-series plot of epidemic at the city level (A) and in each quarter (B).

\newpage
```{r quarter_summary}
case_summary <- case_summary_combined %>%
  dplyr::rename(Quarter = quarter,
                Population = pop,
                Cases = cases,
                Deaths = deaths,
                `Attack Rate (per 100)` = AR,
                `CFR (%)` = CFR)

case_summary$Quarter[case_summary$Quarter=="Combined_lower"] <- "Combined lower"
case_summary$Quarter[case_summary$Quarter=="Combined_upper"] <- "Combined upper"

panderOptions('table.alignment.default',
              function(df)
                ifelse(sapply(df, is.character), 'left', 'right'))
pander(case_summary, big.mark=",", split.cells = 10)
```

## Table 1
Overview of epidemic in each quarter
\newpage


```{r WAIC}
source("functions/waic_dic_summary.R")
load(file = "Data/Rdata/DIC_ls.Rdata")
load(file = "Data/Rdata/waic_ls.Rdata")
mod_names <- c("model 1", "model 2", "model 3",
               "model 4", "model 5", "model 6", "model 7")

dic1 <- DIC_list %>%
  summaryDic() %>%
  data.frame() %>%
  `colnames<-` (mod_names)

dic_select <- bestModel(dic1)

dic_mean <- dic1 %>%
  colMeans() %>%
  data.frame() %>%
  dplyr::mutate(model = mod_names) %>%
  `colnames<-` (c("DIC", "model")) %>%
  dplyr::select(model, DIC)
dic_mean$std <- sapply(dic1, sd)
dic_mean <- dplyr::arrange(dic_mean, DIC)


p_waic <- waic_list %>%
  getP_waic() %>%
  colMeans()


waic1 <- waic_list %>%
  waic_summary %>%
  data.frame() %>%
  `colnames<-`(mod_names)

waic_select <- bestModel(waic1)

waic_mean <- waic1 %>%
  colMeans() %>%
  data.frame() %>%
  dplyr::mutate(model = mod_names) %>%
  `colnames<-` (c("WAIC", "model")) %>%
  dplyr::select(model, WAIC)
waic_mean$std <- sapply(waic1, sd)
waic_mean$p_waic <- p_waic
waic_mean <- dplyr::arrange(waic_mean, WAIC)

pander(waic_select)
```

## Table 2
WAIC values for each epidemic realization. A difference of 5 was considered significant.  
\newpage

```{r regression}

betas <- read.csv("Data/betas-matrix.csv", row.names = 1)
water <- read.csv("Data/water-matrix.csv")
border <- read.csv("Data/border-matrix.csv")
#re-order matrices
matOrderFun <- function(x) {
  x[order(rownames(x)), order(colnames(x))]
}
water <- matOrderFun(water)
border <- matOrderFun(border)

# Convert to vector to lm()
`water-connection` <-as.vector(t(water))
`shared-border` <- as.vector(t(border))

# Make diagnols of beta "NA" since we are not looking at internal transmission
diag(betas) <- NA
betas_vec <- as.vector(t(betas))

lm_border <- lm(log(betas_vec) ~ `shared-border`)
lm_pipes <- lm(log(betas_vec) ~ `water-connection`)

lm_full <- lm(log(betas_vec) ~ `water-connection` + `shared-border`)

pander(lm_full)
```

## Table 3
Linear regression
\newpage

```{r simulationOneStep, fig.width=6.5, fig.height=6.5}
source("functions/SimulationAndPlots.R")
source("multi-neighbor/sim-model-5-data-prep.R")
load(file =  "data/Rdata/sim5_step_data.Rdata")
load(file = "data/Rdata/sim5_step_summary.Rdata")


SimPlot(sim5_step_data, observed_data = I_reps_plot,
        ci = sim5_step_summary, ribbon = TRUE)
```

## Figure 4
The mean number of new infectious cases predicted one-step-ahead with 95% confidence bands. The black lines represent the 10 realizations of the epidemic used as data for parameter fitting. The vertical dotted line represents day 40 for reference between graphs.


```{r rPlots, fig.width=7.0, fig.height=4}
source("functions/plot-functions.R")
load("Data/Rdata/r-values-model-5.Rdata")

# r_int_ext <- R_model5$R_vals %>%
#   filter(R_type == "int" | R_type == "ext" | R_type == "tot")%>%
#   R_log_scale(line_size = 0.5, point_size = 1.5) %>%
#   RExtIntStyle()



r_in_out <-  R_model5$R_vals %>%
  filter(R_type == "in" | R_type == "ext" | R_type == "int" |
         R_type == "tot")%>%
  R_log_scale(pd = 0.6, line_size = 0.4, point_size = 1.5) %>%
  RStyle()

r_in_out

```

## Figure 5
The median external, internal, and total reproductive numbers for each quarter (A), and the median out-flowing and in-flowing reproductive numbers (B). 


```{r}
load(file = 'Data/Rdata/sim-model-5-data-1.Rdata')


```

